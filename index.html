<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thirst Bet</title>
  <style>
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1620;color:#e9f1ff}
    .wrap{max-width:720px;margin:32px auto;padding:0 16px}
    .h1{font-size:34px;font-weight:800;display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .sub{color:#98a6bd;margin-bottom:6px}
    .ver{color:#667a96;font-size:12px;margin-bottom:20px}
    .card{background:#0f1e2d;border-radius:16px;padding:16px;margin:16px 0;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .card-head div{font-weight:700;letter-spacing:.5px}
    button{background:#213147;color:#cfe1ff;border:0;border-radius:12px;padding:8px 14px;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    button:active{transform:translateY(1px)}
    .lines{color:#c3cee3;min-height:24px}
    .line-row{display:grid;grid-template-columns:1fr auto;gap:10px;padding:10px 0;border-top:1px solid rgba(255,255,255,.06)}
    .line-row:first-child{border-top:0}
    .teams{font-weight:600}
    .prices,.time{color:#9ab0c9;font-size:14px}
    .time{grid-column:1/-1}
    .wallet-box{background:#102437;border-radius:12px;padding:12px 16px;margin-bottom:20px;display:flex;flex-direction:column;gap:8px}
    .wallet-box input{background:#0b1620;border:1px solid #22344d;border-radius:8px;padding:8px;color:#e9f1ff;width:100%}
    .leaderboard{margin-top:20px;font-size:14px}
    .leaderboard div{padding:4px 0;border-bottom:1px solid rgba(255,255,255,.05)}
    .stake-row{display:flex;gap:8px;align-items:center;margin-top:6px}
    .stake-input{width:96px;background:#0b1620;border:1px solid #22344d;border-radius:8px;padding:6px;color:#e9f1ff}
    .muted{color:#9ab0c9;font-size:12px;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="h1">üíß Thirst Bet</div>
    <div class="sub">Auto-loaded live lines (NFL & NBA).</div>
    <div class="ver">build: inline-2025-11-15-11</div>

    <div class="wallet-box">
      <div><strong>Verify Wallet</strong></div>
      <input id="walletAddr" placeholder="Enter your Solana wallet address" />
      <button id="verifyBtn">Verify Wallet</button>
      <div id="walletStatus" class="muted"></div>
      <div id="bankroll" class="muted">Bankroll: ‚Äî</div>
    </div>

    <div class="card" id="leaderboardCard" style="display:none;">
      <div class="card-head">
        <div>Leaderboard (This Week)</div>
        <button id="refreshBoard">Refresh</button>
      </div>
      <div class="leaderboard" id="leaderboardBody">Loading...</div>
    </div>

    <div class="card" id="myBetsCard" style="display:none;">
      <div class="card-head">
        <div>My Bets (This Week)</div>
        <button id="refreshMine">Refresh</button>
      </div>
      <div id="myBetsBody" class="leaderboard">No bets yet.</div>
    </div>

    <div class="card" data-sport="NFL">
      <div class="card-head">
        <div>NFL</div>
        <button data-action="refresh" data-sport="NFL">Refresh</button>
      </div>
      <div class="lines">No lines available right now.</div>
      <div class="muted" data-src="NFL">source: ‚Äî</div>
    </div>

    <div class="card" data-sport="NBA">
      <div class="card-head">
        <div>NBA</div>
        <button data-action="refresh" data-sport="NBA">Refresh</button>
      </div>
      <div class="lines">No lines available right now.</div>
      <div class="muted" data-src="NBA">source: ‚Äî</div>
    </div>
  </div>

  <script>
    const API_BASE='https://thirst-bet-backend.onrender.com';
    const uidKey='thirst_uid', walletKey='thirst_wallet';
    window.CSS=window.CSS||{}; CSS.escape=CSS.escape||(s=>String(s).replace(/("|'|\\|\\.|#|\\[|\\]|:|\\(|\\)|\\s)/g,'\\$1'));

    if(!localStorage.getItem(uidKey)) localStorage.setItem(uidKey,'user-'+Math.random().toString(36).slice(2));
    const USER_ID=localStorage.getItem(uidKey);
    let CURRENT_WALLET=localStorage.getItem(walletKey)||'';
    let IS_VERIFIED=false;

    function fetchJSON(url,opts){
      opts=opts||{}; opts.headers=Object.assign({
        'x-user-id':USER_ID,
        'x-wallet-address':CURRENT_WALLET||'',
        'Content-Type':'application/json'
      },opts.headers||{});
      return fetch(url,opts).then(async r=>{ if(!r.ok) throw new Error((await r.text().catch(()=>''))||('HTTP '+r.status)); return r.json(); });
    }
    const asTime=s=>{try{return new Date(s).toLocaleString()}catch(_){return''}};
    const escapeHtml=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    const price=x=>x==null||x===''?'':(Number(x)>0?'+':'')+Math.round(Number(x));

    function shape(c){
      if(c?.line && (c.line.priceA!=null || c.line.priceB!=null))
        return {a:c.line.selectionA,b:c.line.selectionB,pa:c.line.priceA,pb:c.line.priceB,ts:c.startsAt||c.commenceTime,lineId:c.line.id||c.lineId,contestId:c.id||c.contestId};
      if(c?.bestLine)
        return {a:c.bestLine.selectionA,b:c.bestLine.selectionB,pa:c.bestLine.priceA,pb:c.bestLine.priceB,ts:c.startsAt||c.commenceTime,lineId:c.bestLine.id||c.lineId,contestId:c.id||c.contestId};
      return {a:c?.selectionA||'A',b:c?.selectionB||'B',pa:c?.priceA,pb:c?.priceB,ts:c?.startsAt||c?.commenceTime,lineId:c?.id||c?.lineId,contestId:c?.contestId||c?.id};
    }

    async function verifyWallet(addr){
      return fetchJSON(API_BASE+'/wallet/verify',{method:'POST',body:JSON.stringify({address:addr})});
    }

    async function loadLeaderboard(){
      const body=document.getElementById('leaderboardBody'); if(!body) return;
      body.textContent='Loading...';
      try{const res=await fetchJSON(API_BASE+'/leaderboard/weekly');
        body.innerHTML=(res.leaderboard||[]).map(r=>`<div>#${r.rank} ${escapeHtml(r.name||r.userId.slice(0,5))} ‚Äî $${Math.round(r.bankroll)}</div>`).join('')||'No players yet.';
      }catch{body.textContent='Error loading leaderboard'}
    }

    async function refreshMyWeek(){
      if(!CURRENT_WALLET) return;
      try{
        const j=await fetchJSON(API_BASE+'/bets/wallet?wallet='+encodeURIComponent(CURRENT_WALLET));
        document.getElementById('bankroll').textContent='Bankroll: '+Math.round(j.remainingBankroll);
        const body=document.getElementById('myBetsBody');
        body.innerHTML=(j.bets||[]).map(b=>`<div>#${b.lineId} ¬∑ ${b.side} ¬∑ Stake ${b.stake} ¬∑ ${b.status}${b.payout!=null?' ¬∑ Payout '+b.payout:''}</div>`).join('')||'<div class="muted">No bets yet.</div>';
      }catch{}
    }

    // IMPORTANT: once verified, we ONLY pull /contests/open (DB-backed IDs)
    async function fetchLinesAndSource(sport){
      if(IS_VERIFIED){
        try{const r=await fetchJSON(`${API_BASE}/contests/open?sport=${encodeURIComponent(sport)}`);
          return {items:(r&&r.data)||[], source:'/contests/open'};
        }catch{return {items:[], source:'error'};}
      }else{
        try{const r=await fetchJSON(`${API_BASE}/odds?sport=${encodeURIComponent(sport)}`);
          const data=Array.isArray(r)?r:(r.data||r.lines||[]);
          return {items:data, source:'/odds'};
        }catch{return {items:[], source:'error'};}
      }
    }

    function render(target, items, source){
      if(!items||!items.length){ target.textContent='No lines available right now.'; return; }
      let html='';
      const max=Math.min(items.length,50);
      for(let i=0;i<max;i++){
        const c=items[i], L=shape(c);
        const valid=!!(L.lineId && L.contestId);
        const dis = (!IS_VERIFIED || !valid) ? 'disabled' : '';
        html+=`
          <div class="line-row">
            <div class="teams">${escapeHtml(L.a||'A')} vs ${escapeHtml(L.b||'B')}</div>
            <div class="prices">${escapeHtml(price(L.pa))} ¬∑ ${escapeHtml(price(L.pb))}</div>
            <div class="time">${asTime(L.ts)}</div>
            <div class="stake-row">
              <input type="number" min="1" step="1" placeholder="Stake" class="stake-input" data-line="${escapeHtml(String(L.lineId||''))}" data-contest="${escapeHtml(String(L.contestId||''))}">
              <button class="betA" ${dis} data-line="${escapeHtml(String(L.lineId||''))}" data-contest="${escapeHtml(String(L.contestId||''))}">Bet ${escapeHtml(L.a||'A')}</button>
              <button class="betB" ${dis} data-line="${escapeHtml(String(L.lineId||''))}" data-contest="${escapeHtml(String(L.contestId||''))}">Bet ${escapeHtml(L.b||'B')}</button>
            </div>
            ${(!valid && IS_VERIFIED)?'<div class="muted">Waiting for DB IDs‚Ä¶ try Refresh in a few seconds</div>':''}
          </div>`;
      }
      target.innerHTML=html;

      const note=target.parentElement.querySelector('[data-src]');
      if(note) note.textContent='source: '+source;

      target.querySelectorAll('.betA,.betB').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          if(!CURRENT_WALLET||!IS_VERIFIED) return alert('Verify wallet first');
          const side=btn.classList.contains('betA')?'A':'B';
          const lineId=btn.getAttribute('data-line'); const contestId=btn.getAttribute('data-contest');
          const input=target.querySelector(`.stake-input[data-line="${CSS.escape(lineId||'')}"]`);
          const stake=Number(input && input.value ? input.value : '0');
          if(!lineId||!contestId) return alert('Still syncing this line. Tap Refresh and try again.');
          if(!Number.isInteger(stake)||stake<=0) return alert('Enter a valid integer stake');

          try{
            await fetchJSON(API_BASE+'/bets/wallet',{method:'POST',body:JSON.stringify({wallet:CURRENT_WALLET,lineId,contestId,side,stake})});
            alert(`Bet placed: ${side} for ${stake}`);
            if(input) input.value='';
            refreshMyWeek();
          }catch(e){ alert('Bet failed: '+(e?.message||e)); }
        });
      });
    }

    function setBusy(s,b){const btn=document.querySelector(`[data-action="refresh"][data-sport="${s}"]`); if(!btn) return; btn.disabled=!!b; btn.textContent=b?'Loading‚Ä¶':'Refresh';}
    async function loadSport(sport){
      const box=document.querySelector(`[data-sport="${sport}"] .lines`); if(!box) return;
      setBusy(sport,true); box.textContent='Loading...';
      try{const {items,source}=await fetchLinesAndSource(sport); render(box,items,source);}catch{box.textContent='Failed to load lines.';}finally{setBusy(sport,false);}
    }
    document.querySelectorAll('[data-action="refresh"]').forEach(btn=>btn.addEventListener('click',()=>loadSport(btn.getAttribute('data-sport')||'NFL')));

    document.addEventListener('DOMContentLoaded', async ()=>{
      const verifyBtn=document.getElementById('verifyBtn');
      const walletInput=document.getElementById('walletAddr');
      const walletStatus=document.getElementById('walletStatus');

      if(CURRENT_WALLET && walletInput) walletInput.value=CURRENT_WALLET;

      verifyBtn.addEventListener('click',async ()=>{
        const addr=(walletInput && walletInput.value ? walletInput.value : '').trim();
        if(!addr) return alert('Enter wallet address');
        verifyBtn.disabled=true; walletStatus.textContent='Checking balance...';
        try{
          const res=await verifyWallet(addr);
          CURRENT_WALLET=addr; localStorage.setItem(walletKey,addr);
          IS_VERIFIED=!!res.verified;
          if(res.verified){
            walletStatus.innerHTML='‚úÖ Verified! $500 weekly bankroll ready.';
            document.getElementById('leaderboardCard').style.display='block';
            document.getElementById('myBetsCard').style.display='block';
            await Promise.all([loadSport('NFL'),loadSport('NBA'),loadLeaderboard(),refreshMyWeek()]);
          }else{
            walletStatus.textContent='‚ùå Needs at least '+res.required+' $THIRST tokens.';
          }
        }catch(e){ walletStatus.textContent='Error: '+(e.message||e); }
        finally{ verifyBtn.disabled=false; }
      });

      // initial load (pre-verify shows /odds; bets disabled)
      loadSport('NFL'); loadSport('NBA');
      document.getElementById('refreshBoard').addEventListener('click',loadLeaderboard);
      document.getElementById('refreshMine').addEventListener('click',refreshMyWeek);
      if(CURRENT_WALLET){ document.getElementById('leaderboardCard').style.display='block'; document.getElementById('myBetsCard').style.display='block'; refreshMyWeek(); }
    });
  </script>
</body>
</html>