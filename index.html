<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thirst Bet</title>
  <style>
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1620;color:#e9f1ff}
    .wrap{max-width:720px;margin:32px auto;padding:0 16px}
    .h1{font-size:34px;font-weight:800;display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .sub{color:#98a6bd;margin-bottom:6px}
    .ver{color:#667a96;font-size:12px;margin-bottom:20px}
    .card{background:#0f1e2d;border-radius:16px;padding:16px;margin:16px 0;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .card-head div{font-weight:700;letter-spacing:.5px}
    button{background:#213147;color:#cfe1ff;border:0;border-radius:12px;padding:8px 14px;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    button:active{transform:translateY(1px)}
    .lines{color:#c3cee3;min-height:24px}
    .line-row{display:grid;grid-template-columns:1fr auto;gap:10px;padding:10px 0;border-top:1px solid rgba(255,255,255,.06)}
    .line-row:first-child{border-top:0}
    .teams{font-weight:700}
    .prices,.time{color:#9ab0c9;font-size:14px}
    .time{grid-column:1/-1}
    .wallet-box{background:#102437;border-radius:12px;padding:12px 16px;margin-bottom:20px;display:flex;flex-direction:column;gap:8px}
    .wallet-box input,.stake-input{background:#0b1620;border:1px solid #22344d;border-radius:8px;padding:8px;color:#e9f1ff}
    .stake-row{display:flex;gap:8px;align-items:center;margin-top:6px}
    .stake-input{width:96px}
    .leaderboard{margin-top:20px;font-size:14px}
    .leaderboard div{padding:4px 0;border-bottom:1px solid rgba(255,255,255,.05)}
    .muted{color:#9ab0c9;font-size:14px}
    /* toast */
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(8px);background:#14263a;border:1px solid #234;color:#dff;padding:10px 14px;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,.4);opacity:0;pointer-events:none;transition:opacity .18s,transform .18s;font-size:14px}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="h1">üíß Thirst Bet</div>
    <div class="sub">Auto-loaded live lines (NFL & NBA).</div>
    <div class="ver">build: inline-2025-11-15-15g</div>

    <!-- Wallet -->
    <div class="wallet-box">
      <div><strong>Verify Wallet</strong></div>
      <input id="walletAddr" placeholder="Enter your Solana wallet address" />
      <button id="verifyBtn">Verify Wallet</button>
      <div id="walletStatus" class="muted"></div>
      <div id="bankroll" class="muted">Bankroll: ‚Äî</div>
    </div>

    <!-- Leaderboard -->
    <div class="card" id="leaderboardCard" style="display:none;">
      <div class="card-head">
        <div>Leaderboard (This Week)</div>
        <button id="refreshBoard">Refresh</button>
      </div>
      <div class="leaderboard" id="leaderboardBody">Loading...</div>
    </div>

    <!-- My Bets -->
    <div class="card" id="myBetsCard" style="display:none;">
      <div class="card-head">
        <div>My Bets (This Week)</div>
        <button id="refreshMine">Refresh</button>
      </div>
      <div id="myBetsBody" class="leaderboard">No bets yet.</div>
    </div>

    <!-- NFL -->
    <div class="card" data-sport="NFL">
      <div class="card-head">
        <div>NFL</div>
        <button data-action="refresh" data-sport="NFL">Refresh</button>
      </div>
      <div class="lines">Loading official lines‚Ä¶</div>
    </div>

    <!-- NBA -->
    <div class="card" data-sport="NBA">
      <div class="card-head">
        <div>NBA</div>
        <button data-action="refresh" data-sport="NBA">Refresh</button>
      </div>
      <div class="lines">Loading official lines‚Ä¶</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
  /* ===== Inline app ===== */
  const API_BASE = 'https://thirst-bet-backend.onrender.com';
  const uidKey = 'thirst_uid';
  const walletKey = 'thirst_wallet';

  if (!localStorage.getItem(uidKey)) {
    localStorage.setItem(uidKey, 'user-' + Math.random().toString(36).slice(2));
  }
  const USER_ID = localStorage.getItem(uidKey);
  let CURRENT_WALLET = localStorage.getItem(walletKey) || '';

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
  function fetchJSON(url, opts) {
    opts = opts || {};
    opts.headers = Object.assign({
      'x-user-id': USER_ID,
      'Content-Type': 'application/json'
    }, opts.headers || {});
    return fetch(url, opts).then(async r => {
      const txt = await r.text().catch(()=> '');
      if (!r.ok) throw new Error(txt || ('HTTP ' + r.status));
      try { return JSON.parse(txt); } catch { return txt; }
    });
  }

  // UI helpers
  function toast(msg, ms=2000){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=> t.classList.remove('show'), ms);
  }
  function asTime(s){ try { return new Date(s).toLocaleString(); } catch(_) { return ''; } }
  function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
  function formatPrice(x){ if(x===null||x===undefined||x==='')return''; const n=Number(x); if(!isFinite(n))return String(x); return (n>0?'+':'')+Math.round(n); }

  // Wallet
  async function verifyWallet(addr) {
    return fetchJSON(API_BASE + '/wallet/verify', { method:'POST', body: JSON.stringify({ address: addr }) });
  }

  // Leaderboard + My bets
  async function loadLeaderboard(){
    const body = document.getElementById('leaderboardBody');
    if (!body) return;
    body.textContent = 'Loading...';
    try{
      const res = await fetchJSON(API_BASE + '/leaderboard/weekly');
      body.innerHTML = (res.leaderboard || []).map(r =>
        '<div>#'+r.rank+' '+(r.name || r.userId.slice(0,5))+' ‚Äî $'+Math.round(r.bankroll)+'</div>'
      ).join('') || 'No players yet.';
    }catch{ body.textContent = 'Error loading leaderboard'; }
  }
  async function refreshMyWeek(){
    if (!CURRENT_WALLET) return;
    const j = await fetchJSON(API_BASE + '/bets/wallet?wallet=' + encodeURIComponent(CURRENT_WALLET));
    const bankrollEl = document.getElementById('bankroll');
    if (bankrollEl) bankrollEl.textContent = 'Bankroll: ' + Math.round(j.remainingBankroll);
    const body = document.getElementById('myBetsBody');
    if (body) {
      body.innerHTML = (j.bets||[]).map(b => {
        const snap = (b.snapshot && (b.snapshot.selectionA || b.snapshot.selectionB))
          ? ` ¬∑ @ ${escapeHtml(b.snapshot.selectionA||'')}/${escapeHtml(b.snapshot.selectionB||'')}` : '';
        const pay = (b.payout != null) ? (' ¬∑ Payout ' + b.payout) : '';
        return `<div>#${escapeHtml(b.id || String(b.lineId))} ¬∑ ${escapeHtml(b.side)} ¬∑ Stake ${escapeHtml(b.stake)} ¬∑ ${escapeHtml(b.status)}${pay}${snap}</div>`;
      }).join('') || '<div class="muted">No bets yet.</div>';
    }
  }

  // ===== Official lines only (no placeholders) =====
  async function ensureOfficialLines(sport){
    // Try up to 4 attempts with a quick sync+wait between
    for (let i=0;i<4;i++){
      try{
        const r = await fetchJSON(`${API_BASE}/contests/open?sport=${encodeURIComponent(sport)}`);
        const items = (r.data || []).filter(c => c && c.id && c.line && c.line.id);
        if (items.length) return items;
      }catch{}
      try{ await fetchJSON(`${API_BASE}/sync/odds?sport=${encodeURIComponent(sport)}`, {method:'POST'}); }catch{}
      await sleep(900 + i*250); // backoff a touch
    }
    return [];
  }

  function renderLines(target, items, sport){
    if (!items || !items.length) { target.textContent = 'No official lines ‚Äî tap Refresh.'; return; }

    let html = '';
    const max = Math.min(items.length, 50);
    for (let i=0;i<max;i++){
      const c = items[i];
      const L = c.line;
      const a = L.selectionA, b = L.selectionB;
      const pa = formatPrice(L.priceA), pb = formatPrice(L.priceB);
      const ts = asTime(c.startsAt);
      const lineId = L.id, contestId = c.id;

      html += `
        <div class="line-row" data-lineid="${escapeHtml(String(lineId))}" data-contestid="${escapeHtml(String(contestId))}">
          <div class="teams">${escapeHtml(a)} vs ${escapeHtml(b)}</div>
          <div class="prices">${escapeHtml(pa)} ¬∑ ${escapeHtml(pb)}</div>
          <div class="time">${ts}</div>
          <div class="stake-row">
            <input type="number" min="1" step="1" placeholder="Stake" class="stake-input">
            <button class="betA" data-side="A" data-selection="${escapeHtml(a)}" data-price="${escapeHtml(pa)}">Bet ${escapeHtml(a)}</button>
            <button class="betB" data-side="B" data-selection="${escapeHtml(b)}" data-price="${escapeHtml(pb)}">Bet ${escapeHtml(b)}</button>
          </div>
        </div>`;
    }
    target.innerHTML = html;

    // Bind bet clicks
    target.querySelectorAll('.betA, .betB').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        if (!CURRENT_WALLET) return alert('Verify wallet first');
        const row = btn.closest('.line-row');
        const stakeEl = row.querySelector('.stake-input');
        const stake = Number(stakeEl && stakeEl.value ? stakeEl.value : '0');
        if (!Number.isInteger(stake) || stake <= 0) return alert('Enter a valid integer stake');

        const lineId = row.getAttribute('data-lineid');
        const contestId = row.getAttribute('data-contestid');
        const side = btn.getAttribute('data-side');

        try{
          const j = await fetchJSON(API_BASE + '/bets/wallet', {
            method:'POST',
            body: JSON.stringify({ wallet: CURRENT_WALLET, lineId, side, stake, contestId })
          });
          const sel = btn.getAttribute('data-selection') || side;
          const pr  = btn.getAttribute('data-price') || '';
          toast(`Bet ${sel} ${pr} ¬∑ Stake ${stake} ‚Äî placed`);
          if (stakeEl) stakeEl.value = '';
          await refreshMyWeek();
          await loadLeaderboard();
        }catch(e){
          alert((e && e.message) || String(e));
        }
      });
    });
  }

  function setBusy(sport,busy){
    const btn=document.querySelector('[data-action="refresh"][data-sport="'+sport+'"]');
    if (!btn) return;
    btn.disabled = !!busy;
    btn.textContent = busy ? 'Loading‚Ä¶' : 'Refresh';
  }

  async function loadSport(sport){
    const box = document.querySelector('[data-sport="'+sport+'"] .lines');
    if (!box) return;
    setBusy(sport,true);
    box.textContent = 'Loading official lines‚Ä¶';
    try{
      const lines = await ensureOfficialLines(sport);
      renderLines(box, lines, sport);
    }catch(e){
      console.error(e);
      box.textContent = 'Failed to load lines.';
    }finally{
      setBusy(sport,false);
    }
  }

  function bindRefresh(){
    document.querySelectorAll('[data-action="refresh"]').forEach(btn=>{
      btn.addEventListener('click', ()=> loadSport(btn.getAttribute('data-sport') || 'NFL'));
    });
  }

  // Boot
  document.addEventListener('DOMContentLoaded', async ()=>{
    const verifyBtn = document.getElementById('verifyBtn');
    const walletInput = document.getElementById('walletAddr');
    const walletStatus = document.getElementById('walletStatus');

    if (CURRENT_WALLET && walletInput) walletInput.value = CURRENT_WALLET;

    if (verifyBtn) {
      verifyBtn.addEventListener('click', async ()=>{
        const addr = (walletInput && walletInput.value ? walletInput.value : '').trim();
        if (!addr) return alert('Enter wallet address');
        verifyBtn.disabled = true;
        walletStatus.textContent = 'Checking balance...';
        try{
          const res = await verifyWallet(addr);
          CURRENT_WALLET = addr;
          localStorage.setItem(walletKey, addr);
          if (res.verified) {
            walletStatus.innerHTML = '‚úÖ Verified! $500 weekly bankroll ready.';
            document.getElementById('leaderboardCard')?.setAttribute('style','display:block;');
            document.getElementById('myBetsCard')?.setAttribute('style','display:block;');
            await Promise.all([loadLeaderboard(), refreshMyWeek()]);
            await Promise.all([loadSport('NFL'), loadSport('NBA')]);
          } else {
            walletStatus.textContent = '‚ùå Needs at least ' + res.required + ' $THIRST tokens.';
          }
        }catch(e){
          walletStatus.textContent = 'Error: ' + (e.message || e);
        }finally{
          verifyBtn.disabled = false;
        }
      });
    }

    bindRefresh();
    // Initial pulls (no placeholders)
    loadSport('NFL');
    loadSport('NBA');

    document.getElementById('refreshBoard')?.addEventListener('click', loadLeaderboard);
    document.getElementById('refreshMine')?.addEventListener('click', refreshMyWeek);

    if (CURRENT_WALLET) {
      document.getElementById('leaderboardCard')?.setAttribute('style','display:block;');
      document.getElementById('myBetsCard')?.setAttribute('style','display:block;');
      await Promise.all([loadLeaderboard(), refreshMyWeek()]);
    }
  });
  </script>
</body>
</html>